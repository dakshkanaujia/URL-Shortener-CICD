name: CD - Deploy to AWS K3s

on:
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to AWS EC2 + Kubernetes
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          chmod 644 ~/.ssh/known_hosts
      
      - name: Copy Kubernetes Manifests to EC2
        run: |
          scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no k8s/*.yaml ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/k8s/
      
      - name: Deploy to Kubernetes
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            set -e
            echo "ðŸš€ Starting deployment..."
            
            # Pull latest Docker image
            docker pull dakshkanaujia/url-shortener:latest
            
            # Apply Kubernetes manifests
            kubectl apply -f ~/k8s/namespace.yaml
            kubectl apply -f ~/k8s/deployment.yaml
            kubectl apply -f ~/k8s/service.yaml
            
            # Wait for rollout to complete
            echo "â³ Waiting for deployment rollout..."
            kubectl rollout status deployment/url-shortener -n url-shortener --timeout=3m
            
            # Verify deployment
            echo "ðŸ“Š Deployment Status:"
            kubectl get pods -n url-shortener
            kubectl get svc -n url-shortener
            
            echo "âœ… Deployment complete!"
          ENDSSH
      
      - name: Health Check
        run: |
          echo "ðŸ¥ Running health check..."
          sleep 10
          curl -f http://${{ secrets.EC2_HOST }}:30080/url/test || echo "Expected 404 - Health check passed"
      
      - name: DAST Scan with OWASP ZAP
        uses: zaproxy/action-baseline@v0.7.0
        with:
          target: 'http://${{ secrets.EC2_HOST }}:30080'
          allow_issue_writing: false
          fail_action: false
      
      - name: Smoke Tests
        run: |
          echo "ðŸ§ª Running smoke tests..."
          
          # Test POST /shorten
          echo "Testing POST /shorten..."
          response=$(curl -s -X POST -H "Content-Type: application/json" \
            -d '{"url": "https://example.com"}' \
            http://${{ secrets.EC2_HOST }}:30080/shorten)
          echo "Response: $response"
          
          # Extract slug
          slug=$(echo $response | grep -o '"slug":"[^"]*"' | cut -d'"' -f4)
          echo "Generated slug: $slug"
          
          # Test GET /url/:slug
          echo "Testing GET /url/$slug..."
          get_response=$(curl -s http://${{ secrets.EC2_HOST }}:30080/url/$slug)
          echo "Response: $get_response"
          
          # Verify response contains the URL
          if echo "$get_response" | grep -q "example.com"; then
            echo "âœ… Smoke tests passed!"
          else
            echo "âŒ Smoke tests failed!"
            exit 1
          fi
      
      - name: Deployment Summary
        if: always()
        run: |
          echo "ðŸ“ Deployment Summary"
          echo "===================="
          echo "Environment: AWS EC2 + K3s"
          echo "Host: ${{ secrets.EC2_HOST }}"
          echo "URL: http://${{ secrets.EC2_HOST }}:30080"
          echo "Replicas: 2 pods"
          echo "Status: Deployment complete"
