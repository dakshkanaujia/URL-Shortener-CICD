name: CD - Deploy to AWS K3s

on:
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to AWS EC2 + Kubernetes
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      
      - name: Deploy to K3s via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          command_timeout: 10m
          script: |
            echo "ðŸš€ Starting deployment..."
            
            # Pull latest Docker image
            docker pull dakshkanaujia/url-shortener:latest
            
            # Create temp directory for manifests
            mkdir -p ~/k8s-deploy
            cd ~/k8s-deploy
            
            # Create namespace
            cat > namespace.yaml <<'YAML'
            apiVersion: v1
            kind: Namespace
            metadata:
              name: url-shortener
            YAML
            
            # Create deployment
            cat > deployment.yaml <<'YAML'
            apiVersion: apps/v1
            kind: Deployment
            metadata:
              name: url-shortener
              namespace: url-shortener
            spec:
              replicas: 2
              selector:
                matchLabels:
                  app: url-shortener
              template:
                metadata:
                  labels:
                    app: url-shortener
                spec:
                  containers:
                  - name: url-shortener
                    image: dakshkanaujia/url-shortener:latest
                    imagePullPolicy: Always
                    ports:
                    - containerPort: 3000
                    resources:
                      requests:
                        memory: "128Mi"
                        cpu: "100m"
                      limits:
                        memory: "256Mi"
                        cpu: "200m"
            YAML
            
            # Create service
            cat > service.yaml <<'YAML'
            apiVersion: v1
            kind: Service
            metadata:
              name: url-shortener-service
              namespace: url-shortener
            spec:
              type: NodePort
              selector:
                app: url-shortener
              ports:
              - port: 3000
                targetPort: 3000
                nodePort: 30080
            YAML
            
            # Apply manifests
            kubectl apply -f namespace.yaml
            kubectl apply -f deployment.yaml
            kubectl apply -f service.yaml
            
            # Wait for rollout
            echo "â³ Waiting for deployment rollout..."
            kubectl rollout status deployment/url-shortener -n url-shortener --timeout=3m
            
            # Verify deployment
            echo "ðŸ“Š Deployment Status:"
            kubectl get pods -n url-shortener
            kubectl get svc -n url-shortener
            
            echo "âœ… Deployment complete!"

      
      - name: Health Check
        run: |
          echo "ðŸ¥ Running health check..."
          sleep 10
          curl -f http://${{ secrets.EC2_HOST }}:30080/url/test || echo "Expected 404 - Health check passed"
      
      - name: DAST Scan with OWASP ZAP
        uses: zaproxy/action-baseline@v0.7.0
        with:
          target: 'http://${{ secrets.EC2_HOST }}:30080'
          allow_issue_writing: false
          fail_action: false
      
      - name: Smoke Tests
        run: |
          echo "ðŸ§ª Running smoke tests..."
          
          # Test POST /shorten
          echo "Testing POST /shorten..."
          response=$(curl -s -X POST -H "Content-Type: application/json" \
            -d '{"url": "https://example.com"}' \
            http://${{ secrets.EC2_HOST }}:30080/shorten)
          echo "Response: $response"
          
          # Extract slug
          slug=$(echo $response | grep -o '"slug":"[^"]*"' | cut -d'"' -f4)
          echo "Generated slug: $slug"
          
          # Test GET /url/:slug
          echo "Testing GET /url/$slug..."
          get_response=$(curl -s http://${{ secrets.EC2_HOST }}:30080/url/$slug)
          echo "Response: $get_response"
          
          # Verify response contains the URL
          if echo "$get_response" | grep -q "example.com"; then
            echo "âœ… Smoke tests passed!"
          else
            echo "âŒ Smoke tests failed!"
            exit 1
          fi
      
      - name: Deployment Summary
        if: always()
        run: |
          echo "ðŸ“ Deployment Summary"
          echo "===================="
          echo "Environment: AWS EC2 + K3s"
          echo "Host: ${{ secrets.EC2_HOST }}"
          echo "URL: http://${{ secrets.EC2_HOST }}:30080"
          echo "Replicas: 2 pods"
          echo "Status: Deployment complete"
